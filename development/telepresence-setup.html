<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Telepresence Installation and Configuration | CroudTech Development</title>
    <meta name="description" content="Croud developer standards documentation">
    
    
    <link rel="preload" href="/Croud-Standards/assets/css/0.styles.1e2ca596.css" as="style"><link rel="preload" href="/Croud-Standards/assets/js/app.1f93e9c4.js" as="script"><link rel="preload" href="/Croud-Standards/assets/js/2.d995c03c.js" as="script"><link rel="preload" href="/Croud-Standards/assets/js/3.c4c78cfb.js" as="script"><link rel="prefetch" href="/Croud-Standards/assets/js/10.e3cc811a.js"><link rel="prefetch" href="/Croud-Standards/assets/js/11.54c3f5e9.js"><link rel="prefetch" href="/Croud-Standards/assets/js/12.c0a76ea9.js"><link rel="prefetch" href="/Croud-Standards/assets/js/13.d2f0c10e.js"><link rel="prefetch" href="/Croud-Standards/assets/js/14.9e339ad8.js"><link rel="prefetch" href="/Croud-Standards/assets/js/15.2389453f.js"><link rel="prefetch" href="/Croud-Standards/assets/js/16.39994558.js"><link rel="prefetch" href="/Croud-Standards/assets/js/4.b72503fc.js"><link rel="prefetch" href="/Croud-Standards/assets/js/5.aa527b7f.js"><link rel="prefetch" href="/Croud-Standards/assets/js/6.3490551e.js"><link rel="prefetch" href="/Croud-Standards/assets/js/7.7c1e7ee8.js"><link rel="prefetch" href="/Croud-Standards/assets/js/8.f351c9e8.js"><link rel="prefetch" href="/Croud-Standards/assets/js/9.5b5c6d27.js">
    <link rel="stylesheet" href="/Croud-Standards/assets/css/0.styles.1e2ca596.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Croud-Standards/" class="home-link router-link-active"><!----> <span class="site-name">CroudTech Development</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Home</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Development</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Croud-Standards/development/telepresence-setup.html" class="active sidebar-link">Telepresence Installation and Configuration</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Croud-Standards/development/telepresence-setup.html#prerequisites" class="sidebar-link">Prerequisites</a></li><li class="sidebar-sub-header"><a href="/Croud-Standards/development/telepresence-setup.html#process" class="sidebar-link">Process</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Quality</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deployment</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="telepresence-installation-and-configuration"><a href="#telepresence-installation-and-configuration" aria-hidden="true" class="header-anchor">#</a> Telepresence Installation and Configuration</h1> <p>Telepresence provides a VPN solution into the Kubernetes cluster shich means developers can use the Internal Kubernetes DNS service to access resources running in the Cluster without the need for public ingress. This requires a simple setup script outlined below.</p> <h2 id="prerequisites"><a href="#prerequisites" aria-hidden="true" class="header-anchor">#</a> Prerequisites</h2> <ol><li><p>A Github user with membership of the CroudTech organisation and access to the relevant Kubernetes cluster containing the resources to be accessed - this is typically the development cluster at <code>https://rancher2-staging.croud.tech</code></p></li> <li><p>Sudo level workstation privileges<br> <em>This is usually the password used to login to the developer workstation (assuming admin level access).</em></p></li></ol> <h4 id="macos"><a href="#macos" aria-hidden="true" class="header-anchor">#</a> <em>MACOS</em></h4> <p>Homebrew is installed. If this does not exist (check by typing <code>brew</code> into a terminal), homebrew can be installed by following the instructions here: <a href="https://brew.sh/" target="_blank" rel="noopener noreferrer">https://brew.sh/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h4 id="ubuntu"><a href="#ubuntu" aria-hidden="true" class="header-anchor">#</a> <em>UBUNTU</em></h4> <p><strong>Snap</strong> and <strong>Apt</strong> Package Managers are installed</p> <h2 id="process"><a href="#process" aria-hidden="true" class="header-anchor">#</a> Process</h2> <h3 id="_1-install-kubectl"><a href="#_1-install-kubectl" aria-hidden="true" class="header-anchor">#</a> 1. Install kubectl</h3> <p>Kubectl must be installed on the development workstation, and the version installed must be within 1 minor version of the target cluster.</p> <h4 id="macos-2"><a href="#macos-2" aria-hidden="true" class="header-anchor">#</a> <em>MACOS</em></h4> <div class="language- extra-class"><pre class="language-text"><code>curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.10.3/bin/darwin/amd64/kubectl
chmod +x ./kubectl
sudo mv ./kubectl /usr/local/bin/kubectl
</code></pre></div><h4 id="ubuntu-2"><a href="#ubuntu-2" aria-hidden="true" class="header-anchor">#</a> <em>UBUNTU</em></h4> <div class="language-bash extra-class"><pre class="language-bash"><code>$<span class="token operator">&gt;</span> <span class="token function">sudo</span> snap <span class="token function">install</span> kubectl
</code></pre></div><h3 id="_2-configure-kubectl"><a href="#_2-configure-kubectl" aria-hidden="true" class="header-anchor">#</a> 2. Configure kubectl</h3> <p>This assumes that a new installation of kubectl has occured, and no existing configuration files exist.</p> <p>Create a kubectl config file in the following location:</p> <div class="language- extra-class"><pre class="language-text"><code>    ~/.kube/config
</code></pre></div><p>To retrieve valid Kubeconfig file contents, access the rancher UI via the url</p> <p><a href="https://rancher2-staging.croud.tech" target="_blank" rel="noopener noreferrer">https://rancher2-staging.croud.tech<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Login via Gitgub and select the Cluster to which VPN access is required from the list:</p> <p><img src="/Croud-Standards/assets/img/rancher-cluster-list.3ffbd7a2.png" alt="Rancher Homepage"></p> <p>From here select the <code>Kubeconfig file</code> link:</p> <p><img src="/Croud-Standards/assets/img/get-kubeconfig.cf706e47.png" alt="View Kubeconfig"></p> <p>This will reveal a user specific Kubeconfig file:</p> <p><img src="/Croud-Standards/assets/img/copy-kubeconfig.ba7c1047.png" alt="Copy Kubeconfig"></p> <p>Copy the contents and paste into the file created in step 2, a valid file will resemble that shown below:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Config
<span class="token key atrule">clusters</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;development-croud&quot;</span>
  <span class="token key atrule">cluster</span><span class="token punctuation">:</span>
    <span class="token key atrule">server</span><span class="token punctuation">:</span> <span class="token string">&quot;https://rancher2-staging.croud.tech/k8s/clusters/c-m67cb&quot;</span>
    <span class="token key atrule">api-version</span><span class="token punctuation">:</span> v1

<span class="token key atrule">users</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;&lt;&lt;YOUR_USER&gt;&gt;&quot;</span>
  <span class="token key atrule">user</span><span class="token punctuation">:</span>
    <span class="token key atrule">token</span><span class="token punctuation">:</span> <span class="token string">&quot;&lt;&lt;YOUR_TOKEN&gt;&gt;&quot;</span>

<span class="token key atrule">contexts</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;development-croud&quot;</span>
  <span class="token key atrule">context</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> <span class="token string">&quot;&lt;&lt;YOUR_USER&gt;&gt;&quot;</span>
    <span class="token key atrule">cluster</span><span class="token punctuation">:</span> <span class="token string">&quot;development-croud&quot;</span>

<span class="token key atrule">current-context</span><span class="token punctuation">:</span> <span class="token string">&quot;development-croud&quot;</span>
</code></pre></div><h3 id="_3-install-telepresence"><a href="#_3-install-telepresence" aria-hidden="true" class="header-anchor">#</a> 3. Install telepresence</h3> <h4 id="macos-3"><a href="#macos-3" aria-hidden="true" class="header-anchor">#</a> <em>MACOS</em></h4> <p>Install telepresence from homebrew:</p> <div class="language- extra-class"><pre class="language-text"><code>brew cask install osxfuse
brew install datawire/blackbird/telepresence
</code></pre></div><h4 id="ubuntu-3"><a href="#ubuntu-3" aria-hidden="true" class="header-anchor">#</a> <em>UBUNTU</em></h4> <p>Install telepresence via Ubuntu Package Manager:</p> <div class="language- extra-class"><pre class="language-text"><code>$&gt; sudo apt-get update
$&gt; sudo apt-get install telepresence
</code></pre></div><h3 id="_4-connect-to-the-cluster-via-the-telepresence-vpn"><a href="#_4-connect-to-the-cluster-via-the-telepresence-vpn" aria-hidden="true" class="header-anchor">#</a> 4. Connect to the Cluster via the Telepresence VPN</h3> <p>Telepresence will attempt to connect to the cluster currently assigned to  <code>current-context</code> in the kubeconfig file from step 2.</p> <p>Run the command below in the terminal:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$<span class="token operator">&gt;</span> telepresence
   
</code></pre></div><p>After a moment the command prompt will return signifying that telepresence has connected.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>T: Warning: kubectl <span class="token number">1.13</span>.3 may not work correctly with cluster version <span class="token number">1.10</span>.6 
T: due to the version discrepancy. See 
T: https://kubernetes.io/docs/setup/version-skew-policy/ <span class="token keyword">for</span> <span class="token function">more</span> information.   
T: Starting proxy with method <span class="token string">'vpn-tcp'</span>, <span class="token function">which</span> has the following limitations: 
T: All processes are affected, only one telepresence can run per machine, and 
T: you can<span class="token string">'t use other VPNs. You may need to add cloud hosts and headless 
T: services with --also-proxy. For a full list of method limitations see 
T: https://telepresence.io/reference/methods.html
T: Volumes are rooted at <span class="token variable">$TELEPRESENCE_ROOT</span>. See 
T: https://telepresence.io/howto/volumes.html for details.
T: Starting network proxy to cluster using new Deployment 
T: telepresence-1550095525-2570639-5864   
T: No traffic is being forwarded from the remote Deployment to your local 
T: machine. You can use the --expose option to specify which ports you want to 
T: forward.   
T: Guessing that Services IP range is 100.64.0.0/13. Services started after 
T: this point will be inaccessible if are outside this range; restart 
T: telepresence if you can'</span>t access a new Service.
T: Setup complete. Launching your command.

@production-croud-eu-west-3<span class="token operator">|</span>bash-4.4$ 


</code></pre></div><p>Services running within the cluster can now be accessed via the internal rancher DNS service, all requests made from the workstation will attempt to use the Rancher internal DNS</p> <pre><code>http://&lt;&lt;SERVICE&gt;&gt;.&lt;&lt;NAMESPACE&gt;.svc.cluster.local
http://&lt;&lt;SERVICE&gt;&gt;.&lt;&lt;NAMESPACE&gt;
</code></pre> <p>Note that the IP addresses are likely to change frequently, so internal service URLs should be preferred.</p> <h3 id="advanced-setup-proxying-traffic"><a href="#advanced-setup-proxying-traffic" aria-hidden="true" class="header-anchor">#</a> Advanced Setup - Proxying traffic</h3> <p>While the basic setup above can be used gain access to internal services running within the application cluster, Croud development environments are protected via an IP whitelist which requires additional cluster configuration to access over the public internet.  Telepresence can also be used to proxy traffic to specific destinations (IP address, IP Address range or Hostname) via the Telepresence VPN. This means that for developers working on these clusters with a telepresence connection, this additonal whitelisting is not necessary, this is acheived using one or more <code>--also-proxy</code> arguments when opening the Telepresence connection.</p> <p>For example the following command would proxy an public DNS request to the hostname <strong>myingress.example.com</strong> via the Telepresence VPN:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>telepresence --also-proxy myingress.example.com
</code></pre></div><div class="tip custom-block"><p>Use the following command to proxy all traffic to the Croud development load balancer via your Telepresence VPN connection. Replace <strong>myloadbalancer.development.example.com</strong> with the address of the load balancer you wish to proxy, ask the Croud DevOps team for this if you are unsure.</p></div> <div class="language-bash extra-class"><pre class="language-bash"><code>telepresence <span class="token variable"><span class="token variable">$(</span><span class="token function">dig</span> A myloadbalancer.development.example.com <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&quot;IN A&quot;</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print &quot; --also-proxy &quot; <span class="token variable">$5</span>}'</span> <span class="token assign-left variable">ORS</span><span class="token operator">=</span><span class="token string">&quot; &quot;</span><span class="token variable">)</span></span>
</code></pre></div><h4 id="explanation"><a href="#explanation" aria-hidden="true" class="header-anchor">#</a> Explanation</h4> <p>The commands in the $() grab a list of all the A records for the load balancer hostname myloadbalancer.development.example.com (removing the need to manually add IP addresses if the load balancer changes) and adds them as <code>--also-proxy IP</code> arguments for telepresence. So the above command actually runs:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>telepresence  --also-proxy <span class="token number">123.333</span>.222.1  --also-proxy <span class="token number">123.333</span>.222.2  --also-proxy <span class="token number">123.333</span>.222.3
</code></pre></div><p>This will then send all internal kubernetes traffic and external ingress traffic through the telepresence VPN connection.</p> <h3 id="_5-cleanup"><a href="#_5-cleanup" aria-hidden="true" class="header-anchor">#</a> 5. Cleanup</h3> <p>The Telepresence connection creates a pod in the target cluster where the VPN terminates:</p> <p><img src="/Croud-Standards/assets/img/telepresence-sessions.8ac77661.png" alt="Telepresence Sessions"></p> <p>In order to ensure this is removed, the VPN session should be cleanly terminated by running the command below, this will trigger the running pod to be removed.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$<span class="token operator">&gt;</span> @production-croud-eu-west-3<span class="token operator">|</span>bash-4.4$ <span class="token builtin class-name">exit</span>
<span class="token builtin class-name">exit</span>
T: Your process has exited.
T: Exit cleanup <span class="token keyword">in</span> progress
T: Cleaning up Deployment telepresence-1550096881-5661159-11605


</code></pre></div><h3 id="_6-misc"><a href="#_6-misc" aria-hidden="true" class="header-anchor">#</a> 6. Misc.</h3> <p>Run the command below to explore options or consult the Telepresence docs</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$<span class="token operator">&gt;</span> telepresence --help
</code></pre></div><p>If multiple Clusters are configured in Kubeconfig then the desired cluster can be selected using the telepresence  <code>--context</code> command line flag.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$<span class="token operator">&gt;</span> telepresence --context CONTEXT_NAME
</code></pre></div><h3 id="installation-help"><a href="#installation-help" aria-hidden="true" class="header-anchor">#</a> Installation Help</h3> <p>Kubernetes installation docs:</p> <p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/tasks/tools/install-kubectl/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Telepresence installation docs:</p> <p><a href="https://www.telepresence.io/reference/install" target="_blank" rel="noopener noreferrer">https://www.telepresence.io/reference/install<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Croud-Standards/" class="prev router-link-active">Home</a></span> <span class="next"><a href="/Croud-Standards/quality/repo-naming.html">Git Repositories</a>→
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/Croud-Standards/assets/js/app.1f93e9c4.js" defer></script><script src="/Croud-Standards/assets/js/2.d995c03c.js" defer></script><script src="/Croud-Standards/assets/js/3.c4c78cfb.js" defer></script>
  </body>
</html>
